(()=>{"use strict";(()=>{const e=e=>{e.style.display="none"},t=(e,t,o=document)=>{const n=o.querySelector(e);n&&t?n.textContent=t:n&&window.hideNode(n)};window.util={randomInteger:function(e,t){const o=e+Math.random()*(t+1-e);return Math.floor(o)},hideNode:e,showNode:e=>{e.style.display="block"},drawTextBlock:t,mapOffsetCheck:(e,t)=>(e<window.data.mapOverlay[t].START?e=window.data.mapOverlay[t].START:e>window.data.mapOverlay[t].END&&(e=window.data.mapOverlay[t].END),e),showUserMessage:(o,n)=>{const a=document.querySelector("#"+o).content.querySelector("."+o).cloneNode(!0),r=a.querySelector(`.${o}__button`);t(`.${o}__message`,n,a),document.querySelector("body").appendChild(a),r&&r.addEventListener("click",(()=>location.reload())),a&&(a.addEventListener("click",(()=>e(a))),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e(a)})))},contains:(e,t)=>{for(let o=0;o<t.length;o++)if(-1===e.indexOf(t[o]))return!1;return!0},findAndRemove:(e,t)=>{e.splice(e.findIndex((e=>e===t)),1)},changeDisabledAttr:(e,t)=>{t?e.setAttribute("disabled","true"):e.removeAttribute("disabled")}}})(),window.debounce=function(e){let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="GET",t="json",o="10000";window.load=(n,a,r)=>{const i=new XMLHttpRequest;i.open(e,n),i.responseType=t,i.timeout=o,i.addEventListener("error",(function(){r(window.data.messages.load.common)})),i.addEventListener("timeout",(function(){r(`${window.data.messages.load.timeout.pre} ${i.timeout} ${window.data.messages.load.timeout.post}`)})),i.addEventListener("load",(()=>{let e;switch(i.status){case 200:a(i.response);break;case 400:e=window.data.messages.load.err400;break;case 401:e=window.data.messages.load.err401;break;case 404:e=window.data.messages.load.err404;break;default:e=`${window.data.messages.load.status} ${i.status} ${i.statusText}`}e&&r(`${i.status} ${i.statusText}`)})),i.send()}})(),window.upload=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{let e;switch(o.status){case 200:t(window.data.messages.upload.success);break;case 400:e=window.data.messages.upload.err400;break;case 401:e=window.data.messages.upload.err401;break;case 404:e=window.data.messages.upload.err404;break;default:e=`${window.data.messages.upload.status} ${o.status} ${o.statusText}`}e&&window.util.showUserMessage("error",`${o.status} ${o.statusText}`)})),o.open("POST"," https://21.javascript.pages.academy/keksobooking"),o.send(e)},(()=>{const e={X:25,Y:70},t=document.querySelector(".map__overlay"),o=document.querySelector(".map__pin--main"),n={y:{START:130,END:630},x:{START:0-o.offsetWidth/2,END:t.offsetWidth-o.offsetWidth/2}},a="Уютный очаг на краю города",r="Теплое место, последнее пристанище расплавленного ума",i=e=>e.features.filter((()=>window.util.randomInteger(0,1))),s=e=>e.photos.filter((()=>window.util.randomInteger(0,1)));window.load("https://21.javascript.pages.academy/keksobooking/data",(e=>{var t;window.data.houses=(e=>e.filter((e=>e.offer)))(((t=e).forEach(((e,t)=>{e.frontId=t})),t)),window.controlPin.setActiveState()}),(e=>{window.util.showUserMessage("error",e)})),window.data={mapOverlay:n,pinOffset:e,mockHouses:((t,o)=>{const d=[];for(let o=0;o<8;o++){const c={x:window.util.randomInteger(n.x.START,n.x.END),y:window.util.randomInteger(n.y.START+e.Y,n.y.END)};d.push({author:{avatar:`img/avatars/user0${o+1}.png`},offer:{title:a,address:`${c.x}, ${c.y}`,price:window.util.randomInteger(999,9999),type:t.types[window.util.randomInteger(0,3)],rooms:window.util.randomInteger(1,5),guests:window.util.randomInteger(1,8),checkin:t.checkin[window.util.randomInteger(0,2)],checkout:t.checkin[window.util.randomInteger(0,2)],features:i(t),description:r,photos:s(t)},location:{x:c.x,y:c.y}})}return d})({types:["palace","flat","house","bungalow"],checkin:["12:00","13:00","14:00"],features:["wifi","dishwasher","parking","washer","elevator","conditioner"],photos:["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"]}),messages:{filter:{noResult:"Объявления которые соответствуют заданным фильтрам не были найдены"},load:{common:"Произошла ошибка соединения",err400:"Неверный запрос",err401:"Пользователь не авторизован",err404:"Ничего не найдено",status:"Статус ответа:",timeout:{pre:"Запрос не успел выполниться за",post:"мс"}},upload:{success:"Ваша заявка успешно отправлена",err400:"Неверный запрос",err401:"Пользователь не авторизован",err404:"Ничего не найдено",status:"Статус ответа:"}}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.card=(()=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__close"),n=document.querySelector(".map__filters-container"),a=t.querySelector(".popup__features"),r=a.querySelector(".popup__feature").cloneNode(!0),i=t.querySelector(".popup__photos"),s=i.querySelector(".popup__photo").cloneNode(!0),d=()=>{window.pin.removeActiveStyles(),window.card.clear()},c=e=>{e.preventDefault(),d()},l=e=>{e.preventDefault(),"Escape"===e.key&&d()};return{draw:d=>{window.util.drawTextBlock(".popup__title",d.offer.title,t),window.util.drawTextBlock(".popup__text--address",d.offer.address,t),window.util.drawTextBlock(".popup__text--price",d.offer.price+"₽/ночь",t),window.util.drawTextBlock(".popup__type",e[d.offer.type],t),window.util.drawTextBlock(".popup__text--capacity",`${d.offer.rooms} комнаты для ${d.offer.guests} гостей`,t),window.util.drawTextBlock(".popup__text--time",`Заезд после ${d.offer.checkin}, выезд до ${d.offer.checkout}`,t),(e=>{if(e&&a){const t=document.createDocumentFragment();e.forEach((e=>{r.className="popup__feature popup__feature--"+e,t.appendChild(r)})),a.innerHTML="",a.appendChild(t)}else a&&window.util.hideNode(a)})(d.offer.features),window.util.drawTextBlock(".popup__description",d.offer.description,t),(e=>{if(e&&i){const t=document.createDocumentFragment();e.forEach((e=>{s.src=e,t.appendChild(s)})),i.innerHTML="",i.appendChild(t)}else i&&window.util.hideNode(i)})(d.offer.photos),(e=>{const o=t.querySelector(".popup__avatar");e&&o?o.src=e:o&&window.util.hideNode(o)})(d.author.avatar),n.before(t),t.classList.remove("hidden"),o.addEventListener("click",c),document.addEventListener("keydown",l)},clear:()=>{t.classList.add("hidden"),o.removeEventListener("click",c),document.removeEventListener("click",l)}}})()})(),window.pin=(()=>{const e=document.querySelector("#map"),t=document.querySelector("#pin"),o=document.createDocumentFragment(),n=document.querySelector(".map__pins"),a=[],r=()=>{a.forEach((e=>{e.remove()}))},i=()=>{n.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))},s=e=>{const t=e.target.offsetParent;t&&t.dataset.frontId&&(i(),t.classList.add("map__pin--active"),window.card.draw(window.data.houses[e.target.offsetParent.dataset.frontId]))},d=e=>{"Enter"===e.key&&e.target.dataset.frontId&&window.card.draw(window.data.houses[e.target.dataset.frontId])};return{draw:e=>{e.forEach((e=>{const n=t.content.querySelector(".map__pin").cloneNode(!0);n.querySelector("img").src=e.author.avatar,n.style=`left: ${e.location.x-window.data.pinOffset.X}px; top: ${e.location.y-window.data.pinOffset.Y}px`,n.attributes.src=e.author.avatar,n.attributes.alt=e.offer.title,n.dataset.frontId=e.frontId,o.appendChild(n),a.push(n)})),n.appendChild(o),n.addEventListener("click",s),n.addEventListener("keydown",d)},clear:r,close:()=>{e.classList.add("map--faded"),r(),window.controlPin.setMapState(!1),n.removeEventListener("click",s),n.removeEventListener("keydown",d)},removeActiveStyles:i}})(),(()=>{const e={maxCount:5,type:"any",price:"any",rooms:"any",guests:"any",features:[]};let t=Object.assign({},e);const o=document.querySelector("#pins-filter"),n=e=>{const n=o.querySelector("#housing-"+e);n.addEventListener("input",window.debounce((o=>{o.preventDefault(),t[e]=n.value,a()})))},a=()=>{let e=window.data.houses;"any"!==t.type&&(e=e.filter((e=>e.offer.type===t.type))),"any"!==t.price&&(e=e.filter((e=>(e=>{let t;return e<1e4?t="low":1e4<=e&&e<5e4?t="middle":5e4<=e&&(t="high"),t})(+e.offer.price)===t.price))),"any"!==t.rooms&&(e=e.filter((e=>+e.offer.rooms==+t.rooms))),"any"!==t.guests&&(e=e.filter((e=>+e.offer.guests==+t.guests))),t.features!==[]&&(e=e.filter((e=>window.util.contains(e.offer.features,t.features)))),0===e.length?window.util.showUserMessage("success",window.data.messages.filter.noResult):(e=e.slice(0,t.maxCount),window.card.clear(),window.pin.clear(),window.pin.draw(e))};n("type"),n("price"),n("rooms"),n("guests"),(()=>{const e=o.querySelector("#housing-features").querySelectorAll('input[name="features"]'),n=e=>{e.preventDefault();const o=e.target.id.replace(/filter-/gi,"");!0===e.target.checked?t.features.push(o):window.util.findAndRemove(t.features,o),a()};e.forEach((e=>{e.addEventListener("input",window.debounce(n))}))})(),window.filter={submit:a,reset:()=>{o.reset(),t=Object.assign({},e)}}})(),(()=>{const e=document.querySelector("#ad-form"),t=document.querySelector("#price"),o={MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,type:[{name:"bungalow",MIN_PRICE:0},{name:"flat",MIN_PRICE:1e3},{name:"house",MIN_PRICE:5e3},{name:"palace",MIN_PRICE:1e4}],rooms:[{roomsCount:1,guestOptions:[{value:1,text:"для 1 гостя"}]},{roomsCount:2,guestOptions:[{value:1,text:"для 1 гостя"},{value:2,text:"для 2 гостей"}]},{roomsCount:3,guestOptions:[{value:1,text:"для 1 гостя"},{value:3,text:"для 3 гостей"},{value:2,text:"для 2 гостей"}]},{roomsCount:100,guestOptions:[{value:1,text:"не для гостей"}]}],minPrice:5e3},n=()=>{o.minPrice=5e3,t.placeholder=5e3};document.querySelector(".ad-form__reset").addEventListener("click",(t=>{t.preventDefault(),e.reset(),n(),window.pin.close(),window.filter.reset(),window.card.clear(),window.controlPin.setAddress()})),window.form={rooms:{initValidation:()=>{const e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),n=document.querySelector("#capacity option"),a=()=>{o.rooms.forEach((o=>{if(o.roomsCount===+e.value){const e=document.createDocumentFragment();o.guestOptions.forEach((t=>{const o=n.cloneNode();o.innerText=t.text,o.value=t.value,e.appendChild(o)})),t.innerHTML="",t.appendChild(e)}}))};e.addEventListener("input",(()=>{a()})),a()}},checkin:{initValidation:()=>{const e=document.querySelector("#timein"),t=document.querySelector("#timeout");e.addEventListener("input",(()=>{t.value=e.value})),t.addEventListener("input",(()=>{e.value=t.value}))}},minPrice:{initValidation:()=>{const e=document.querySelector("#type"),n=()=>{t.value<o.minPrice?t.setCustomValidity(`Минимальная цена выбранного типа апартаментов ${o.minPrice} руб.`):t.setCustomValidity(""),t.reportValidity()};e.addEventListener("input",(e=>{(e=>{o.type.forEach((n=>{n.name===e.target.value&&(o.minPrice=n.MIN_PRICE,t.attributes.min=o.minPrice,t.placeholder=o.minPrice)}))})(e),n()})),t.addEventListener("input",(()=>{n()}))}},title:{initValidation:()=>{const e=document.querySelector("#title");e.addEventListener("input",(()=>{const t=e.value.length;t<o.MIN_NAME_LENGTH?e.setCustomValidity(`Ещё ${o.MIN_NAME_LENGTH-t} симв.`):t>o.MAX_NAME_LENGTH?e.setCustomValidity(`Удалите лишние ${t-o.MAX_NAME_LENGTH} симв.`):e.setCustomValidity(""),e.reportValidity()}))}},initSubmit:()=>{e.addEventListener("submit",(t=>{t.preventDefault(),window.upload(new FormData(e),(e=>{window.pin.close(),window.card.clear(),window.filter.reset(),n(),window.util.showUserMessage("success",e)}))}))}}})(),(()=>{const e=/[^-0-9]/gim,t=document.querySelector(".map__pin--main"),o={LEFT:t.style.left,TOP:t.style.top},n=e=>{document.querySelector(".map__filters").querySelectorAll("select, input").forEach((t=>{window.util.changeDisabledAttr(t,!e)}))},a=e=>{const t=document.querySelector(".ad-form");t.querySelectorAll("fieldset").forEach((t=>{window.util.changeDisabledAttr(t,!e)})),e?(t.classList.remove("ad-form--disabled"),window.filter.submit(),window.form.rooms.initValidation(),window.form.minPrice.initValidation(),window.form.title.initValidation(),window.form.checkin.initValidation(),window.form.initSubmit()):(t.classList.add("ad-form--disabled"),t.reset())},r=()=>{const o=document.querySelector("#address"),n=+t.style.left.replace(e,"")+25,a=+t.style.top.replace(e,"")+70;o.value=`${n}, ${a}`},i=e=>{e?(document.querySelector(".map").classList.remove("map--faded"),a(!0),n(!0),window.form.rooms.initValidation()):(a(!1),n(!1),t.addEventListener("mousedown",(e=>{0===e.button&&i(!0)}),{once:!0}),t.addEventListener("keydown",(e=>{"Enter"===e.key&&i(!0)}),{once:!0}),t.style.left=o.LEFT,t.style.top=o.TOP,r())};window.controlPin={init:()=>{window.util.hideNode(t),i(!1),r(),t.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(e=>{let o={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=o.x-e.clientX,a=o.y-e.clientY;o={x:e.clientX,y:e.clientY},t.style.top=window.util.mapOffsetCheck(t.offsetTop-a,"y")+"px",t.style.left=window.util.mapOffsetCheck(t.offsetLeft-n,"x")+"px"},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),r()};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)})(e)}))},setActiveState:()=>{window.util.showNode(t)},setMapState:i,setAddress:r}})(),window.controlPin.init()})();